---
title: "The Influence of Questionable Research Practices on the Sequential ANOVA"
subtitle: "*DGPs 2024*"
# author: "<br>**Meike Steinhilber<sup>1</sup>**, Martin Schnuerch<sup>2</sup>, and Anna-Lena Schubert<sup>1</sup>"
# institute: "1 University of Mainz, 2 University of Mannheim"
format:
  revealjs:
    theme: [default, css/MS_clean.scss]
    toc: false
    toc-depth: 3
    toc-title: "Contens"
    number-sections: false
    number-depth: 1
    footer: "DGPs -- Steinhilber"
    include-after-body: no_footer_on_title_page.html
    chalkboard: false
    slide-number: true
    highlight-style: a11y
    code-link: false
    preview-links: true
    embed-resources: true
    slide-level: 2
    # logo: images/white_space.png
    # header: "fgme2023 -- Steinhilber"
    # header-logo: images/logo.png
    hide-from-titleSlide: "text"
author:
  - name: Meike Steinhilber
    orcid: 0000-0002-7144-2100
    email: Meike.Steinhilber@uni-mainz.de
    affiliations: University of Mainz
  - name: Martin Schnuerch
    orcid: 0000-0001-6531-2265
    email: martin.schnuerch@uni-mannheim.de
    affiliations: University of Mannheim
  - name: Anna-Lena Schubert
    orcid: 0000-0001-7248-0662
    email: anna-lena.schubert@uni-mainz.de
    affiliations: University of Mainz
filters:
- reveal-header # https://github.com/shafayetShafee/reveal-header
- css/appendix.lua
- css/custom_header.lua
    #css: [syntax-highlight.css]
execute:
  echo: true
  warning: true
---

```{r copy folder, echo=FALSE, eval=FALSE, include=FALSE}
file.copy("plots", "presentation", recursive = TRUE)
file.copy("tables", "presentation", recursive = TRUE)
```

```{r}
#| echo: false
#| output: false
#| include: false
library(papaja)
library(trackdown)
library(knitr)
library(dplyr)
library(kableExtra)
library(ggplot2) 
library(glue)
library(latex2exp)
library(purrr)
library(readr)
library(magrittr)
library(magick)

palette <- "RdYlBu"  #"Dark2"
green <- "#69b3a2"
blue <- "#2c7bb6"  #"#404080"
light_blue <- "#abd9e9"
red <- 	"#d7191c" #"#ca0020" "#CD2626" "#8B0000"
light_red <- "#fca4a4" # "red"
orange <- "#fdae61"
yellow <- "#ffffbf"

theme_set(theme_bw(base_size = 12))
base_size <- 18

n_rep <- 10000
distribution <- "normal"
dist <- gsub("_", " ", distribution)
length_f_exp <- 3

linesep <- function(x,y=character()){
  if (!length(x))
    return(y)
  linesep(x[-length(x)], c(rep('',x[length(x)]-1),'\\addlinespace',y))  
}

knitr::opts_knit$set(root.dir = glue::glue("{rprojroot::find_rstudio_root_file()}/presentation/"))
```

::: set-custom-header
SPRT
:::

# Sequential Probability Ratio Test (SPRT) {background-color="var(--background)"}

-   Sequential *t*-tests
-   Sequential ANOVAs <br><br> Wald (1945)

## Basic idea

-   hypotheses ($H_0$, $H_1$)
-   sequential data collection
-   repeated calculation of the test statistic
-   decision
-   very efficient

![](images/gif_sprt.gif){.absolute .fragment bottom="10%" right="5%" width="50%"}

##  {#slide-id58 .no-title data-menu-title="58%"}

<br/><br/><br/><br/><br/><br>

::: {.one-line-statements .no-title}
On average, [58% less data]{.inline-red-highlight} is collected with a sequential ANOVA compared to a fixed ANOVA.
:::

## Robustness

![](images/example_unequal_sample_size.png){width="45%"} ![](images/example_unequal_variance.png){width="45%"} ![](images/example_mixture_distribution.png){width="45%"}

##  {#slide-idosf .no-title data-menu-title="OSF"}

<!-- ::: {.column width="70%"} -->

![](images/paper1.png){.images-shadow} <!-- ::: -->

::: set-custom-header
Hacking the sequential ANOVA
:::

# Hacking the sequential ANOVA {background-color="var(--background)"}

## Lessons learned from the replication crisis

::::: columns
::: {.column width="50%"}
**in the past:**

-   test was created

-   people started using it

-   misunderstandings and QRPs developed

-   replication crisis

-   [post-hoc analyses of QRP]{.inline-red-highlight}
:::

::: {.fragment .column width="50%"}
**SPRTs:**

-   test was created

-   test has fallen into oblivion

-   replication crisis

-   test was rediscovered & implemented in software

-   [a priori analysis of QRP]{.inline-red-highlight}

-   ...

-   researchers may start using the test
:::
:::::

## Simulation

::::: columns
::: {.column width="70%"}
**The imaginary researcher:**

-   never collects more than 280 data points (95% power for a medium effect size in a fixed sampling plan)

-   prefers a $H_1$ decision over a $H_0$

-   prefers a $H_0$ decision over a non-decision

**Settings**

-   $f_{exp} = 0.25$
-   $f_{true} = 0, 0.25$
-   $\alpha = \beta = 0.05$
-   $N = 10,000$
:::

::: {.column width="30%"}
![](images/researchers.webp){.images-shadow}
:::
:::::

## Strategy overview

::: {layout-ncol="4"}
![outlier analysis](../plots/outlier_examle_normal_1000_sd_1_1_1_1_r_1_1_1_1_n_70_f_0_i_32.png)

![subgroup analysis](../plots/subgroup_examle_normal_1000_sd_1_1_1_1_r_1_1_1_1_n_70_f_0_i_52.png){width="90%"}

![switch to fix design](../plots/switch_examle_normal_1000_sd_1_1_1_1_r_1_1_1_1_n_70_f_0_i_31.png)

![Adjust the power](../plots/power_examle_normal_10_sd_1_1_1_1_r_1_1_1_1_n_70_f_0.25_i_1.png){width="90%"}

![multiple $f_{exp}$](../plots/multiple_fexp_examle_normal_1000_sd_1_1_1_1_r_1_1_1_1_n_70_f_0_i_73.png)

![sequential $f_{exp}$](../plots/adjust_f_examle_normal_1000_sd_1_1_1_1_r_1_1_1_1_n_70_f_0_i_250.png){width="75%"}

![shuffling the data](../plots/shuffle_examle_normal_1000_sd_1_1_1_1_r_1_1_1_1_n_70_f_0_i_2.png)

![filtering the data](../plots/filtered_data_examle_normal_1000_sd_1_1_1_1_r_1_1_1_1_n_70_f_0_i_1.png)
:::

## Outlier analysis

::::: columns
::: {.column width="60%"}
![](../plots/outlier_examle_normal_1000_sd_1_1_1_1_r_1_1_1_1_n_70_f_0_i_32.png)
:::

::: {.column width="40%"}
:::
:::::

## Subgroup analysis

::::: columns
::: {.column width="60%"}
![](../plots/subgroup_examle_normal_1000_sd_1_1_1_1_r_1_1_1_1_n_70_f_0_i_52.png){width="80%"}
:::

::: {.column width="40%"}
:::
:::::

## Switch to fix design

::::: columns
::: {.column width="60%"}
![](../plots/switch_examle_normal_1000_sd_1_1_1_1_r_1_1_1_1_n_70_f_0_i_31.png)
:::

::: {.column width="40%"}
:::
:::::

<!-- ## Adjust the power -->

<!-- :::: columns -->

<!-- ::: {.column width="60%" } -->

<!-- ![](../plots/power_examle_normal_10_sd_1_1_1_1_r_1_1_1_1_n_70_f_0.25_i_1.png){width="80%"} -->

<!-- ::: -->

<!-- ::: {.column width="40%" } -->

<!-- ::: -->

<!-- :::: -->

## Multiple $f_{exp}$

::::: columns
::: {.column width="60%"}
![](../plots/multiple_fexp_examle_normal_1000_sd_1_1_1_1_r_1_1_1_1_n_70_f_0_i_73.png)
:::

::: {.column width="40%"}
:::
:::::

<!-- ## Sequential adjustment of $f_{exp}$ -->

<!-- :::: columns -->

<!-- ::: {.column width="50%" } -->

<!-- ![](../plots/adjust_f_examle_normal_1000_sd_1_1_1_1_r_1_1_1_1_n_70_f_0_i_250.png){width="80%"} -->

<!-- ::: -->

<!-- ::: {.column width="50%" } -->

<!-- ::: -->

<!-- :::: -->

## Shuffling the data

::::: columns
::: {.column width="60%"}
![](../plots/shuffle_examle_normal_1000_sd_1_1_1_1_r_1_1_1_1_n_70_f_0_i_2.png)
:::

::: {.column width="40%"}
<br> <br> <br>

-   The order of the data is rearranged 20 times (whereby the data structure is maintained)
:::
:::::

## Filtering the data

::::: columns
::: {.column width="60%"}
![](../plots/filtered_data_examle_normal_1000_sd_1_1_1_1_r_1_1_1_1_n_70_f_0_i_1.png)
:::

::: {.column width="40%"}
:::
:::::

## Combination of strategies

:::::: columns
::: {.column width="33%"}
### subgroup & outlier

![](../plots/subgroup_examle_normal_1000_sd_1_1_1_1_r_1_1_1_1_n_70_f_0_i_52.png){width="60%"}

![](../plots/outlier_examle_normal_1000_sd_1_1_1_1_r_1_1_1_1_n_70_f_0_i_32.png){width="60%"}
:::

::: {.column width="33%"}
### outlier & multiple spec

![](../plots/outlier_examle_normal_1000_sd_1_1_1_1_r_1_1_1_1_n_70_f_0_i_32.png){width="60%"}

![](../plots/multiple_fexp_examle_normal_1000_sd_1_1_1_1_r_1_1_1_1_n_70_f_0_i_73.png){width="60%"}
:::

::: {.column width="33%"}
### subgroup & multiple spec

![](../plots/subgroup_examle_normal_1000_sd_1_1_1_1_r_1_1_1_1_n_70_f_0_i_52.png){width="60%"}

![](../plots/multiple_fexp_examle_normal_1000_sd_1_1_1_1_r_1_1_1_1_n_70_f_0_i_73.png){width="60%"}
:::
::::::

::: set-custom-header
Simulation results
:::

# Simulation results {background-color="var(--background)"}

##  {#slide-errorrates1 .no-title data-menu-title="Error-Rates"}

![](../plots/error_rates_stacked_n_rep10000_2.png){width="80%"}

##  {#slide-errorrates2 .no-title data-menu-title="Error-Rates"}

![](../plots/error_rates_stacked_n_rep10000_3.png){width="80%"}

<!-- ### Effect size estimation -->

<!-- ![](../plots/f_adj_estimation_base_1_n_rep_base10000_1.png){width="80%"} -->

<!-- ### Effect size estimation -->

<!-- ![](../plots/f_adj_estimation_base_2_n_rep_base10000.png){width="80%"} -->

## Effect size estimation

![](../plots/f_adj_estimation_estim_1_n_rep10000.png){width="80%"}

## Effect size estimation

![](../plots/f_adj_estimation_estim_2_n_rep10000.png){width="80%"}

## Summary

<br> <br>

::: {layout="[10, 10, 20, 20]"}
![](images/smaller_sample_size_normal_n_rep10000.png)

![](images/robustness.png){.fragment}

![](../plots/error_rates_stacked_n_rep10000.png){.fragment}

![](../plots/f_adj_estimation_estim_2_n_rep10000.png){.fragment}
:::

::: set-custom-header
:::

## Contact

::::: columns
::: {.column width="60%"}
<br/> **Software:**

-   [sprtt](https://meikesteinhilber.github.io/sprtt/) (CRAN Package)

-   [Spirit](https://meike-steinhilber.shinyapps.io/spirit/) (Shiny Web App)

<br/><br/> <br/>

**Contact:**

GitHub: [MeikeSteinhilber](https://github.com/MeikeSteinhilber)

Twitter: [M_Steinhilber](https://twitter.com/M_Steinhilber)

E-Mail: meike.steinhilber\@uni-mainz.de
:::

::: {.column width="40%" left="50%"}
<br/><br/> <br/><br/> <br/><br/> <br/><br/> <br/> <br/>

**Thanks to my collaborators:**

Anna-Lena Schubert

Martin Schnuerch
:::
:::::

![](images/sprtt_qr_code.png){.absolute top="20%" left="60%" width="200"}

::: set-custom-header
Appendix
:::

# Appendix {.appendix background-color="var(--background)"}

##  {#slide-id1 .no-title data-menu-title="SPRT"}

![](images/sprt_formulas.png)

## Efficiency

::::: columns
::: {.column width="50%"}
![](images/smaller_sample_size_normal_n_rep10000.png)
:::

::: {.column width="50%"}
<br> <br>

-   based on **120,000** simulated cases

-   $f_{exp} = 0.10, 0.25, 0.40$

-   $f_{true} = 0, 0.10, 0.25, 0.40$
:::
:::::

## Effect size estimation

![](../plots/f_adj_estimation_base_1_n_rep_base10000.png){width="80%"}

## Error rates

![](images/results.png){width="80%"}

## Efficiency

![](../plots/sample_size_strategies_n_rep10000.png)

## Likelihood ratio

::::: columns
::: column
$$
\begin{equation}
\begin{split}
\textbf{X}^{(n)} = \{
&\mathbf{x}_1 =(x_{1,1}, ..., x_{1,n}), \\
&...,\\
&\mathbf{x}_k =(x_{k,1}, ..., x_{k,n})\},
\end{split}
\end{equation}
$$ <br>

\begin{equation}
\begin{split}
LR_{n} &= \frac{f(\mathbf{X}^{(n)};\ H_1)}{f(\mathbf{X}^{(n)};\ H_0)} \label{eqn:line-1}\\
& = \frac{f(F_{2}, F_{3}, ..., F_{n};\ H_1)}{f(F_{2}, F_{3},..., F_{n};\ H_0)} \label{eqn:line-2}\\
& = \frac{f(F_n;\ df_{1}, df_{2n}, \Delta_{n})}{f(F_n;\ df_{1}, df_{2n})} \label{eqn:line-3}
\end{split}
\label{eqn:lr}
\end{equation}
:::

::: column
\begin{equation}
\begin{split}
df_1 &= k - 1,\\
df_{2,n} &= N - k,\\
\\
\Delta_n &= f_{exp}^2 \cdot N,\\
\\
F_n &= \frac
  {SS_{\mathrm{effect},n}/df_1}
  {SS_{\mathrm{residual},n}/df_{2,n}}, \\
\\
SS_{\mathrm{effect},n} &= \sum_{i=1}^k n(\bar{x}_i - \bar{x})^2, \\
SS_{\mathrm{residual},n} &= \sum_{i=1}^k \sum_{j=1}^n (x_{i,j} - \bar{x}_i)^2
\end{split}
\end{equation}
:::
:::::

## Continue sampling

<br><br><br><br>

::: {style="text-align:center;"}
sampling continues as long as: <br><br>
:::

\begin{equation}
\frac{\beta}{1-\alpha}
< \frac{f(F_n;\ df_{1}, df_{2n}, \Delta_{n})}{f(F_n;\ df_{1}, df_{2n})}
< \frac{1 - \beta}{\alpha}
\end{equation}

## Sample sizes {visibility="uncounted"}

```{r}
#| echo: false
#| warning: false
#| message: false
#| include: false
# setwd("./presentation")
img <- image_read("tables/sample-sizes.png", strip = TRUE) %>%
  image_draw(.)
x <- image_info(img)$width
y <- image_info(img)$height
rect(xleft = x*.01,
     xright = x*.77,
     ybottom = y*.335,
     ytop = y*.28,
     border = red, lwd = 8)
dev.off()
```

```{r}
#| echo: false
#| warning: false
#| message: false
img
```

## Unequal sample sizes or unequal variance

![](tables/error-rates-unequal.png){width="80%"}

## Unequal sample Sizes & Variance

![](tables/error-rates-unequal-2.png){width="80%"}

## Mixture distribution

![](tables/error-rates-mixture.png){width="80%"}

## Effect size estimation bias

![](images/f_estimation_normal_sd1_1_1_1_sr1_1_1_1.png){width="80%"}
